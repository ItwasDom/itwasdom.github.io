<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; base-uri 'self'; object-src 'none'; form-action 'self'; img-src 'self' data: https:; style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; font-src 'self' https://cdnjs.cloudflare.com data:; script-src 'self' 'unsafe-inline' https://www.gstatic.com https://www.googleapis.com https://apis.google.com https://cdnjs.cloudflare.com; script-src-attr 'none'; connect-src 'self' https://*.googleapis.com https://*.firebaseio.com https://www.googleapis.com https://*.cloudfunctions.net; frame-src 'self' https://*.firebaseapp.com https://*.google.com https://accounts.google.com;">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Portfolio - Dominic Martinez</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
  <link rel="stylesheet" href="../styles.css">
  <style>
    .portfolio-page-container {
      max-width: 1200px;
      margin: 120px auto 60px;
      padding: 0 20px;
    }

    .back-to-home {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      color: #7C3AED;
      text-decoration: none;
      font-weight: 600;
      margin-bottom: 40px;
      transition: all 0.3s ease;
    }

    .back-to-home:hover {
      transform: translateX(-5px);
    }

    .portfolio-title {
      font-size: 2.8rem;
      text-align: center;
      background: linear-gradient(135deg, #1B16A8 0%, #7C3AED 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 50px;
      font-weight: 800;
    }

    .portfolio-feed-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 18px;
      margin-bottom: 60px;
      max-width: 1200px;
      margin-left: auto;
      margin-right: auto;
    }

    @media (max-width: 900px) {
      .portfolio-feed-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 14px;
      }
    }

    @media (max-width: 600px) {
      .portfolio-feed-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 12px;
      }

      .portfolio-feed-content p,
      .portfolio-feed-tags {
        display: none;
      }
    }

    .portfolio-feed-item {
      background: linear-gradient(135deg, rgba(27, 22, 168, 0.12) 0%, rgba(124, 58, 237, 0.12) 100%);
      border-radius: 18px;
      overflow: hidden;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      cursor: pointer;
      border: 1px solid rgba(124, 58, 237, 0.28);
      text-decoration: none;
      color: inherit;
      display: flex;
      flex-direction: column;
      animation: fadeInBounce 0.8s ease-out;
      position: relative;
    }

    .portfolio-feed-item:hover {
      transform: translateY(-12px) scale(1.02);
      box-shadow: 0 20px 50px rgba(124, 58, 237, 0.3);
      border-color: rgba(124, 58, 237, 0.55);
    }

    .portfolio-feed-item img {
      width: 100%;
      aspect-ratio: 1 / 1;
      height: auto;
      object-fit: cover;
      transition: all 0.4s ease-in-out;
      filter: brightness(1);
      display: block;
      border-radius: 16px;
      margin: 0;
      padding: 0;
    }

    .portfolio-feed-item:hover img {
      filter: brightness(1.05) contrast(1.05);
      transform: scale(1.03);
    }

    .portfolio-feed-item.is-placeholder {
      cursor: default;
    }

    .portfolio-feed-item.is-placeholder:hover {
      transform: none;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      border-color: rgba(124, 58, 237, 0.28);
    }

    .portfolio-placeholder-hero {
      width: 100%;
      height: 280px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      font-weight: 800;
      font-size: 1.05rem;
      color: #f0f0f0;
      background: linear-gradient(135deg, rgba(27, 22, 168, 0.22) 0%, rgba(124, 58, 237, 0.18) 100%);
      border-radius: 16px;
    }

    .portfolio-feed-content {
      padding: 18px;
      background: rgba(15, 15, 15, 0.9);
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
      transition: all 0.3s ease-in-out;
      opacity: 0.85;
    }

    .portfolio-feed-content h3 {
      font-size: 1.1rem;
      color: #7C3AED;
      margin: 0;
      font-weight: 700;
    }

    .portfolio-feed-content p {
      font-size: 0.85rem;
      color: #aaa;
      margin: 0;
      line-height: 1.4;
      flex-grow: 1;
    }

    .portfolio-feed-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .portfolio-feed-tags span {
      background: rgba(124, 58, 237, 0.2);
      color: #7C3AED;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      border: 1px solid rgba(124, 58, 237, 0.3);
      transition: all 0.3s ease-in-out;
    }

    .portfolio-feed-tags span:hover {
      background: rgba(124, 58, 237, 0.35);
      border-color: rgba(124, 58, 237, 0.6);
    }

    .portfolio-footer-message {
      text-align: center;
      color: #999;
      font-size: 1.1rem;
      padding: 40px 20px;
      border-top: 1px solid rgba(124, 58, 237, 0.22);
      margin-top: 40px;
    }

    .portfolio-actions {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 14px;
      margin: -25px 0 35px;
      flex-wrap: wrap;
    }

    .follow-btn {
      padding: 10px 16px;
      border-radius: 999px;
      border: 2px solid #7C3AED;
      background: transparent;
      color: #7C3AED;
      cursor: pointer;
      font-weight: 700;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .follow-btn.following {
      background: rgba(124, 58, 237, 0.16);
    }

    .followers-count {
      color: #aaa;
      font-size: 0.95rem;
    }

    .like-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
    }

    .like-count {
      color: #aaa;
      font-size: 0.85rem;
    }

    .like-btn {
      border: 2px solid rgba(124, 58, 237, 0.55);
      background: transparent;
      color: #7C3AED;
      border-radius: 999px;
      padding: 8px 12px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-weight: 700;
      font-size: 0.85rem;
    }

    .like-btn.liked {
      background: rgba(239, 68, 68, 0.16);
      border-color: rgba(239, 68, 68, 0.7);
      color: #ef4444;
    }

    .like-btn.liked i {
      color: #ef4444;
    }

    @media (max-width: 768px) {
      .portfolio-page-container {
        margin-top: 100px;
      }

      .portfolio-title {
        font-size: 2rem;
      }

      .portfolio-feed-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 12px;
      }

      .portfolio-feed-item img {
        aspect-ratio: 1 / 1;
        height: auto;
      }

      .portfolio-feed-item:hover img {
        transform: scale(1.02);
      }

      .portfolio-feed-content {
        padding: 16px;
      }

      .portfolio-feed-content h3 {
        font-size: 1rem;
      }

      .portfolio-feed-content p {
        font-size: 0.8rem;
      }
    }

    /* ===== Portfolio Details Modal ===== */
    .portfolio-modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.75);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 22px;
      z-index: 2000;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    .portfolio-modal-overlay.open {
      display: flex;
    }

    .portfolio-modal {
      width: min(980px, 100%);
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      border: 1px solid rgba(124, 58, 237, 0.35);
      border-radius: 18px;
      box-shadow: 0 30px 80px rgba(0, 0, 0, 0.6);
      overflow: hidden;
      max-height: 90vh;
      height: 90vh;
      max-height: 720px;
      display: flex;
      flex-direction: row;
    }

    .portfolio-modal-left {
      height: 100%;
      min-height: 0;
      flex: 1.2 1 0;
      display: grid;
      grid-template-rows: 1fr auto;
    }

    .portfolio-modal-media {
      background: #0b0b12;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 320px;
      position: relative;
      min-height: 0;
      overflow: hidden;
    }

    .portfolio-modal-carousel {
      width: 100%;
      height: 100%;
      overflow-x: auto;
      overflow-y: hidden;
      display: flex;
      scroll-snap-type: x mandatory;
      scroll-behavior: smooth;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      touch-action: auto;
      overscroll-behavior-x: contain;
    }

    @media (hover: hover) and (pointer: fine) {
      .portfolio-modal-carousel {
        cursor: grab;
      }
    }

    .portfolio-modal-carousel.dragging {
      cursor: grabbing;
      scroll-behavior: auto;
    }

    .portfolio-modal-carousel::-webkit-scrollbar {
      display: none;
    }

    .portfolio-modal-slide {
      flex: 0 0 100%;
      width: 100%;
      height: 100%;
      scroll-snap-align: center;
      scroll-snap-stop: always;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .portfolio-modal-slide img {
      width: 100%;
      height: 100%;
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      display: block;
      user-select: none;
      -webkit-user-drag: none;
    }

    .portfolio-modal-nav {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 42px;
      height: 42px;
      border-radius: 999px;
      border: 2px solid rgba(124, 58, 237, 0.55);
      background: rgba(0, 0, 0, 0.35);
      color: #7C3AED;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 2;
    }

    .portfolio-modal-nav:disabled {
      opacity: 0.4;
      cursor: default;
    }

    .portfolio-modal-nav.prev { left: 12px; }
    .portfolio-modal-nav.next { right: 12px; }

    .portfolio-modal-thumbs {
      display: flex;
      gap: 10px;
      padding: 12px;
      border-top: 1px solid rgba(124, 58, 237, 0.18);
      overflow-x: auto;
      background: rgba(0, 0, 0, 0.12);
      flex: 0 0 auto;
    }

    .portfolio-modal-thumb {
      width: 84px;
      height: 64px;
      border-radius: 10px;
      border: 2px solid rgba(124, 58, 237, 0.25);
      background: #0b0b12;
      overflow: hidden;
      cursor: pointer;
      flex: 0 0 auto;
      padding: 0;
    }

    .portfolio-modal-thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      filter: brightness(0.9);
    }

    .portfolio-modal-thumb.active {
      border-color: rgba(124, 58, 237, 0.85);
      box-shadow: 0 10px 30px rgba(124, 58, 237, 0.18);
    }

    .portfolio-modal-body {
      padding: 22px;
      overflow: auto;
      min-height: 0;
      flex: 1 1 0;
    }

    .portfolio-modal-top {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 14px;
      margin-bottom: 12px;
    }

    .portfolio-modal-title {
      font-size: 1.4rem;
      font-weight: 800;
      color: #f0f0f0;
      margin: 0;
      line-height: 1.2;
    }

    .portfolio-modal-close {
      border: 2px solid rgba(124, 58, 237, 0.55);
      background: transparent;
      color: #7C3AED;
      border-radius: 10px;
      width: 42px;
      height: 42px;
      cursor: pointer;
      font-weight: 800;
    }

    .portfolio-modal-desc {
      color: #bbb;
      font-size: 0.95rem;
      line-height: 1.7;
      margin: 10px 0 14px;
      white-space: pre-wrap;
    }

    .portfolio-modal-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 10px 0 14px;
    }

    .portfolio-modal-tags span {
      background: rgba(124, 58, 237, 0.2);
      color: #7C3AED;
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 0.8rem;
      font-weight: 700;
      border: 1px solid rgba(124, 58, 237, 0.3);
    }

    .portfolio-modal-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-top: 14px;
      flex-wrap: wrap;
    }

    .portfolio-modal-comments {
      margin-top: 14px;
      padding-top: 14px;
      border-top: 1px solid rgba(124, 58, 237, 0.18);
      display: none;
    }

    .portfolio-modal-comments.open {
      display: block;
    }

    .portfolio-modal-comments-row {
      display: flex;
      gap: 10px;
      align-items: flex-start;
    }

    .portfolio-modal-comments textarea {
      width: 100%;
      min-height: 84px;
      resize: vertical;
      border-radius: 12px;
      border: 2px solid rgba(124, 58, 237, 0.35);
      background: rgba(0, 0, 0, 0.18);
      color: #f0f0f0;
      padding: 10px 12px;
      font-size: 0.95rem;
      line-height: 1.5;
    }

    .portfolio-modal-comments-list {
      margin-top: 12px;
      display: grid;
      gap: 10px;
    }

    .portfolio-modal-comment {
      border: 1px solid rgba(124, 58, 237, 0.22);
      background: rgba(0, 0, 0, 0.12);
      border-radius: 12px;
      padding: 10px 12px;
      color: #ddd;
      white-space: pre-wrap;
    }

    .portfolio-modal-comment-meta {
      color: #aaa;
      font-size: 0.8rem;
      margin-bottom: 6px;
    }

    .portfolio-modal-comment-status {
      color: #aaa;
      font-size: 0.85rem;
      margin-top: 8px;
    }

    .portfolio-modal-comments-preview {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid rgba(124, 58, 237, 0.18);
    }

    .portfolio-modal-comments-preview-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 10px;
    }

    .portfolio-modal-comments-preview-title {
      color: #f0f0f0;
      font-weight: 800;
      font-size: 0.95rem;
      margin: 0;
    }

    .portfolio-modal-open {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      border-radius: 999px;
      border: 2px solid rgba(124, 58, 237, 0.55);
      background: transparent;
      color: #7C3AED;
      font-weight: 800;
      text-decoration: none;
    }

    @media (max-width: 860px) {
      .portfolio-modal {
        display: flex;
        flex-direction: column;
        height: 90vh;
        max-height: 90vh;
      }

      .portfolio-modal-left {
        flex: 0 0 auto;
        max-height: 58vh;
      }

      .portfolio-modal-media {
        min-height: 220px;
      }

      .portfolio-modal-body {
        padding: 18px;
        flex: 1 1 auto;
        min-height: 0;
      }

      .portfolio-modal-nav {
        width: 38px;
        height: 38px;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <div class="logo"><a href="../index.html" style="text-decoration: none; color: inherit;">Dominic Martinez</a></div>
      <nav>
        <ul class="nav-links">
          <li><a href="../about/index.html">About</a></li>
          <li><a href="../experience/index.html">Experience</a></li>
          <li><a href="../skills/index.html">Skills</a></li>
          <li><a href="../portfolio/index.html">Portfolio</a></li>
          <li><a href="../connect/index.html">Connect</a></li>
          <li class="auth-nav-item">
            <a id="authNavBtn" href="../user/login.html" class="login-nav-btn">Login / Sign Up</a>
            <div id="authDropdown" class="auth-dropdown">
              <a id="authDashboardLink" href="../user/dashboard.html">My Dashboard</a>
              <a href="#" id="authLogoutBtn">Logout</a>
            </div>
          </li>
        </ul>
      </nav>
    </div>
  </header>

  <div class="portfolio-page-container">
    <a href="../index.html#portfolio" class="back-to-home">
      <i class="fas fa-arrow-left"></i>
      Back to Home
    </a>

    <h1 class="portfolio-title">My Work</h1>

    <div class="portfolio-actions">
      <button id="followBtn" class="follow-btn" type="button">
        <i class="fas fa-user-plus"></i>
        <span id="followBtnText">Follow</span>
      </button>
      <span id="followersCount" class="followers-count"></span>
    </div>

    <div class="portfolio-feed-grid" id="portfolioGrid" aria-live="polite"></div>

    <div class="portfolio-footer-message" id="portfolioStatus">Loading portfolio…</div>

    <div class="portfolio-footer-message">
      <p>Interested in a project? <a href="../index.html#connect" style="color: #7C3AED; text-decoration: none; font-weight: 600;">Get in touch</a></p>
    </div>
  </div>

  <!-- Portfolio details modal -->
  <div id="portfolioModalOverlay" class="portfolio-modal-overlay" aria-hidden="true">
    <div class="portfolio-modal" role="dialog" aria-modal="true" aria-labelledby="portfolioModalTitle">
      <div class="portfolio-modal-left">
        <div class="portfolio-modal-media">
          <button id="portfolioModalPrev" class="portfolio-modal-nav prev" type="button" aria-label="Previous image">
            <i class="fas fa-chevron-left" aria-hidden="true"></i>
          </button>
          <div id="portfolioModalCarousel" class="portfolio-modal-carousel" aria-label="Project images"></div>
          <button id="portfolioModalNext" class="portfolio-modal-nav next" type="button" aria-label="Next image">
            <i class="fas fa-chevron-right" aria-hidden="true"></i>
          </button>
        </div>
        <div id="portfolioModalThumbs" class="portfolio-modal-thumbs" aria-label="Project images"></div>
      </div>
      <div class="portfolio-modal-body">
        <div class="portfolio-modal-top">
          <h2 id="portfolioModalTitle" class="portfolio-modal-title"></h2>
          <button id="portfolioModalClose" class="portfolio-modal-close" type="button" aria-label="Close">
            <i class="fas fa-times"></i>
          </button>
        </div>

        <div id="portfolioModalTags" class="portfolio-modal-tags"></div>
        <p id="portfolioModalDesc" class="portfolio-modal-desc"></p>

        <div class="portfolio-modal-actions">
          <span id="portfolioModalLikeCount" class="like-count"></span>
          <button id="portfolioModalLikeBtn" class="like-btn" type="button">
            <i class="fas fa-heart" aria-hidden="true"></i> Like
          </button>
          <button id="portfolioModalCommentBtn" class="portfolio-modal-open" type="button">
            <i class="fas fa-comment" aria-hidden="true"></i> Comment
          </button>
          <a id="portfolioModalOpenImage" class="portfolio-modal-open" href="#" target="_blank" rel="noopener noreferrer">
            <i class="fas fa-arrow-up-right-from-square" aria-hidden="true"></i> Open Image
          </a>
        </div>

        <div id="portfolioModalActionStatus" class="portfolio-modal-comment-status" aria-live="polite"></div>

        <div id="portfolioModalCommentsPreview" class="portfolio-modal-comments-preview" aria-label="Comments preview">
          <div class="portfolio-modal-comments-preview-header">
            <p class="portfolio-modal-comments-preview-title">Comments</p>
            <button id="portfolioModalCommentsPreviewMore" class="portfolio-modal-open" type="button" style="display:none;">… see more</button>
          </div>
          <div id="portfolioModalCommentsPreviewStatus" class="portfolio-modal-comment-status"></div>
          <div id="portfolioModalCommentsPreviewList" class="portfolio-modal-comments-list"></div>
        </div>

        <div id="portfolioModalComments" class="portfolio-modal-comments" aria-label="Comments">
          <div class="portfolio-modal-comments-row">
            <textarea id="portfolioModalCommentInput" placeholder="Write a comment…"></textarea>
            <button id="portfolioModalCommentSend" class="portfolio-modal-open" type="button">Post</button>
          </div>
          <div id="portfolioModalCommentStatus" class="portfolio-modal-comment-status"></div>
          <div id="portfolioModalCommentList" class="portfolio-modal-comments-list"></div>
        </div>
      </div>
    </div>
  </div>

  <footer>
    <div class="container">
      &copy; 2026 Dominic Martinez. All rights reserved.
    </div>
  </footer>

  <!-- Firebase (for auth-aware nav) -->
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-functions-compat.js"></script>
  <script src="/assets/js/firebase-config.js"></script>
  <script src="/assets/js/firebase-init-compat.js"></script>
  <script src="/assets/js/auth-nav.js"></script>

  <script>
    (function () {
      const auth = firebase.auth();
      const db = firebase.firestore();
      const fns = firebase.functions();
      const toggleLikeCallable = fns.httpsCallable('togglePortfolioLike');
      const setFollowingCallable = fns.httpsCallable('setFollowingDominic');
      const sendLikeNotificationCallable = fns.httpsCallable('sendLikeNotification');
      const sendFollowNotificationCallable = fns.httpsCallable('sendFollowNotification');
      const listCommentsCallable = fns.httpsCallable('listPortfolioComments');
      const addCommentCallable = fns.httpsCallable('addPortfolioComment');
      const getCurrentUserLikesCallable = fns.httpsCallable('getCurrentUserLikes');

      let currentUser = null;
      let userLikes = {};
      let isFollowing = false;
      let portfolioItems = [];

      let modalCarouselUrls = [];
      let modalCarouselThumbs = [];
      let modalCarouselTitle = '';
      let modalCarouselIndex = 0;
      let modalScrollRaf = 0;
      let modalItemId = '';
      let modalCommentsCache = [];

      function setLikeButtonVisual(btn, liked) {
        if (!btn) return;
        const isLiked = liked === true;
        btn.classList.toggle('liked', isLiked);
        btn.innerHTML = `<i class="fas fa-heart" aria-hidden="true"></i> ${isLiked ? 'Liked' : 'Like'}`;
      }

      function applyLocalLikeUpdate(photoId, nextLiked, nextLikeCount) {
        const id = typeof photoId === 'string' ? photoId : '';
        if (!id) return;
        if (typeof nextLiked === 'boolean') {
          userLikes = { ...(userLikes || {}), [id]: nextLiked };
        }

        if (Number.isFinite(Number(nextLikeCount))) {
          const n = Number(nextLikeCount);
          if (Array.isArray(portfolioItems)) {
            portfolioItems = portfolioItems.map((it) => {
              if (!it || it.id !== id) return it;
              return { ...it, likeCount: n };
            });
          }
        }
      }

      function clamp(n, min, max) {
        return Math.min(max, Math.max(min, n));
      }

      function getModalEls() {
        return {
          overlay: document.getElementById('portfolioModalOverlay'),
          titleEl: document.getElementById('portfolioModalTitle'),
          carouselEl: document.getElementById('portfolioModalCarousel'),
          descEl: document.getElementById('portfolioModalDesc'),
          tagsEl: document.getElementById('portfolioModalTags'),
          likeEl: document.getElementById('portfolioModalLikeCount'),
          likeBtn: document.getElementById('portfolioModalLikeBtn'),
          commentBtn: document.getElementById('portfolioModalCommentBtn'),
          actionStatus: document.getElementById('portfolioModalActionStatus'),
          commentsPreview: document.getElementById('portfolioModalCommentsPreview'),
          commentsPreviewStatus: document.getElementById('portfolioModalCommentsPreviewStatus'),
          commentsPreviewList: document.getElementById('portfolioModalCommentsPreviewList'),
          commentsPreviewMore: document.getElementById('portfolioModalCommentsPreviewMore'),
          commentsPanel: document.getElementById('portfolioModalComments'),
          commentInput: document.getElementById('portfolioModalCommentInput'),
          commentSend: document.getElementById('portfolioModalCommentSend'),
          commentStatus: document.getElementById('portfolioModalCommentStatus'),
          commentList: document.getElementById('portfolioModalCommentList'),
          openLink: document.getElementById('portfolioModalOpenImage'),
          thumbsEl: document.getElementById('portfolioModalThumbs'),
          prevBtn: document.getElementById('portfolioModalPrev'),
          nextBtn: document.getElementById('portfolioModalNext'),
          closeBtn: document.getElementById('portfolioModalClose'),
        };
      }

      function formatCommentTime(ts) {
        try {
          const d = ts instanceof Date ? ts : null;
          if (!d) return '';
          return d.toLocaleString();
        } catch {
          return '';
        }
      }

      function renderModalCommentsPreview() {
        const { commentsPreviewStatus, commentsPreviewList, commentsPreviewMore } = getModalEls();
        if (!commentsPreviewStatus || !commentsPreviewList || !commentsPreviewMore) return;

        const comments = Array.isArray(modalCommentsCache) ? modalCommentsCache : [];
        commentsPreviewList.innerHTML = '';

        if (comments.length === 0) {
          commentsPreviewStatus.textContent = 'No comments yet.';
          commentsPreviewMore.style.display = 'none';
          return;
        }

        commentsPreviewStatus.textContent = '';
        comments.slice(0, 2).forEach((c) => {
          const wrap = document.createElement('div');
          wrap.className = 'portfolio-modal-comment';

          const meta = document.createElement('div');
          meta.className = 'portfolio-modal-comment-meta';
          const name = (c && typeof c.displayName === 'string' && c.displayName.trim()) ? c.displayName.trim() : 'User';
          const createdAtMs = Number.isFinite(Number(c && c.createdAt)) ? Number(c.createdAt) : 0;
          const when = createdAtMs ? formatCommentTime(new Date(createdAtMs)) : '';
          meta.textContent = when ? `${name} • ${when}` : name;

          const body = document.createElement('div');
          body.textContent = (c && typeof c.text === 'string') ? c.text : '';

          wrap.appendChild(meta);
          wrap.appendChild(body);
          commentsPreviewList.appendChild(wrap);
        });

        commentsPreviewMore.style.display = comments.length > 2 ? '' : 'none';
      }

      function renderModalCommentsFull() {
        const { commentStatus, commentList } = getModalEls();
        if (!commentStatus || !commentList) return;

        const comments = Array.isArray(modalCommentsCache) ? modalCommentsCache : [];
        commentList.innerHTML = '';

        if (comments.length === 0) {
          commentStatus.textContent = 'No comments yet.';
          return;
        }

        commentStatus.textContent = '';
        comments.forEach((c) => {
          const wrap = document.createElement('div');
          wrap.className = 'portfolio-modal-comment';

          const meta = document.createElement('div');
          meta.className = 'portfolio-modal-comment-meta';
          const name = (c && typeof c.displayName === 'string' && c.displayName.trim()) ? c.displayName.trim() : 'User';
          const createdAtMs = Number.isFinite(Number(c && c.createdAt)) ? Number(c.createdAt) : 0;
          const when = createdAtMs ? formatCommentTime(new Date(createdAtMs)) : '';
          meta.textContent = when ? `${name} • ${when}` : name;

          const body = document.createElement('div');
          body.textContent = (c && typeof c.text === 'string') ? c.text : '';

          wrap.appendChild(meta);
          wrap.appendChild(body);
          commentList.appendChild(wrap);
        });
      }

      async function loadModalComments() {
        const { commentStatus, commentList, commentsPreviewStatus, commentsPreviewList, commentsPreviewMore, commentsPanel } = getModalEls();
        if (!commentStatus || !commentList || !commentsPreviewStatus || !commentsPreviewList || !commentsPreviewMore) return;
        commentsPreviewStatus.textContent = 'Loading comments…';
        commentsPreviewList.innerHTML = '';
        commentsPreviewMore.style.display = 'none';
        if (commentsPanel && commentsPanel.classList.contains('open')) {
          commentStatus.textContent = 'Loading comments…';
          commentList.innerHTML = '';
        } else {
          commentStatus.textContent = '';
          commentList.innerHTML = '';
        }

        const id = (typeof modalItemId === 'string') ? modalItemId : '';
        if (!id) {
          commentsPreviewStatus.textContent = '';
          return;
        }

        try {
          const res = await listCommentsCallable({ photoId: id, limit: 20 });
          const data = res && res.data ? res.data : {};
          modalCommentsCache = Array.isArray(data.comments) ? data.comments : [];
          renderModalCommentsPreview();
          if (commentsPanel && commentsPanel.classList.contains('open')) {
            renderModalCommentsFull();
          }
        } catch (err) {
          console.warn('Comment load failed:', err);
          const code = (err && typeof err.code === 'string') ? err.code : '';
          if (code.includes('permission-denied')) {
            commentsPreviewStatus.textContent = 'Comments are blocked (Cloud Functions permission/App Check).';
            if (commentStatus) commentStatus.textContent = 'Comments are blocked (Cloud Functions permission/App Check).';
          } else if (code.includes('not-found')) {
            commentsPreviewStatus.textContent = 'Comments service not deployed yet.';
            if (commentStatus) commentStatus.textContent = 'Comments service not deployed yet.';
          } else {
            commentsPreviewStatus.textContent = 'Could not load comments right now.';
            if (commentStatus) commentStatus.textContent = 'Could not load comments right now.';
          }
        }
      }

      function updateModalThumbActive() {
        const { thumbsEl } = getModalEls();
        if (!thumbsEl) return;
        const buttons = Array.from(thumbsEl.querySelectorAll('.portfolio-modal-thumb'));
        buttons.forEach((btn, idx) => btn.classList.toggle('active', idx === modalCarouselIndex));
      }

      function updateModalNavState() {
        const { prevBtn, nextBtn, openLink } = getModalEls();
        const total = Array.isArray(modalCarouselUrls) ? modalCarouselUrls.length : 0;
        const hasMany = total > 1;

        if (prevBtn) {
          prevBtn.style.display = hasMany ? '' : 'none';
          prevBtn.disabled = !hasMany || modalCarouselIndex <= 0;
        }
        if (nextBtn) {
          nextBtn.style.display = hasMany ? '' : 'none';
          nextBtn.disabled = !hasMany || modalCarouselIndex >= total - 1;
        }

        if (openLink) {
          const url = total ? modalCarouselUrls[modalCarouselIndex] : null;
          if (url) {
            openLink.href = url;
            openLink.style.display = '';
          } else {
            openLink.href = '#';
            openLink.style.display = 'none';
          }
        }

        updateModalThumbActive();
      }

      function scrollModalToIndex(nextIndex, behavior = 'smooth') {
        const { carouselEl } = getModalEls();
        if (!carouselEl) return;
        const total = Array.isArray(modalCarouselUrls) ? modalCarouselUrls.length : 0;
        if (!total) return;
        const idx = clamp(Number(nextIndex) || 0, 0, total - 1);
        modalCarouselIndex = idx;

        const slides = carouselEl.querySelectorAll('.portfolio-modal-slide');
        const slide = slides && slides[idx] ? slides[idx] : null;
        if (slide && typeof slide.scrollIntoView === 'function') {
          slide.scrollIntoView({ behavior, block: 'nearest', inline: 'start' });
        } else {
          const left = (carouselEl.clientWidth || 0) * idx;
          carouselEl.scrollTo({ left, top: 0, behavior });
        }
        updateModalNavState();
      }

      function normalizeHttpUrl(url) {
        if (typeof url !== 'string') return null;
        try {
          const u = new URL(url, window.location.href);
          if (u.protocol !== 'http:' && u.protocol !== 'https:') return null;
          return u.href;
        } catch {
          return null;
        }
      }

      function clearElement(el) {
        if (!el) return;
        while (el.firstChild) el.removeChild(el.firstChild);
      }

      function setStatus(text) {
        const statusEl = document.getElementById('portfolioStatus');
        if (statusEl) statusEl.textContent = text;
      }

      function setFollowersCount(n) {
        const el = document.getElementById('followersCount');
        if (!el) return;
        const num = Number.isFinite(Number(n)) ? Number(n) : 0;
        el.textContent = `${num.toLocaleString()} follower${num === 1 ? '' : 's'}`;
      }

      function setFollowButtonState() {
        const btn = document.getElementById('followBtn');
        const text = document.getElementById('followBtnText');
        if (!btn || !text) return;

        if (!currentUser) {
          btn.classList.remove('following');
          text.textContent = 'Follow';
          return;
        }

        if (isFollowing) {
          btn.classList.add('following');
          text.textContent = 'Following';
        } else {
          btn.classList.remove('following');
          text.textContent = 'Follow';
        }
      }

      function createCard(item) {
        const imageUrlsRaw = Array.isArray(item && item.imageUrls)
          ? item.imageUrls
          : (item && item.imageUrl ? [item.imageUrl] : []);
        const imageUrls = imageUrlsRaw.map((u) => normalizeHttpUrl(u)).filter(Boolean).slice(0, 10);
        const thumbUrlsRaw = Array.isArray(item && item.thumbUrls)
          ? item.thumbUrls
          : (item && item.thumbUrl ? [item.thumbUrl] : []);
        const thumbUrls = thumbUrlsRaw.map((u) => normalizeHttpUrl(u)).filter(Boolean).slice(0, 10);
        const alignedThumbs = (thumbUrls.length >= imageUrls.length)
          ? thumbUrls.slice(0, imageUrls.length)
          : thumbUrls.concat(imageUrls.slice(thumbUrls.length));

        const imageUrl = imageUrls.length ? imageUrls[0] : null;
        const thumbUrl = alignedThumbs.length ? alignedThumbs[0] : imageUrl;
        const title = (item && typeof item.title === 'string' && item.title.trim()) ? item.title.trim() : 'Untitled';
        const description = (item && typeof item.description === 'string' && item.description.trim()) ? item.description.trim() : '';
        const category = (item && typeof item.category === 'string' && item.category.trim()) ? item.category.trim() : '';
        const id = (item && typeof item.id === 'string' && item.id.trim()) ? item.id.trim() : '';
        const likeCountRaw = item && item.likeCount;
        const likeCount = Number.isFinite(Number(likeCountRaw)) ? Number(likeCountRaw) : 0;
        const liked = !!(id && userLikes && userLikes[id] === true);

        const card = document.createElement('div');
        card.className = 'portfolio-feed-item';
        card.setAttribute('role', 'button');
        card.setAttribute('tabindex', '0');
        card.setAttribute('aria-label', title);

        const open = (opts = {}) => {
          openPortfolioModal({
            id,
            title,
            description,
            category,
            imageUrl,
            imageUrls,
            thumbUrls: alignedThumbs,
            likeCount,
            openComments: opts.openComments === true,
          });
        };

        card.addEventListener('click', (e) => {
          e.preventDefault();
          open();
        });

        card.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            open();
          }
        });

        const img = document.createElement('img');
        img.loading = 'lazy';
        img.decoding = 'async';
        img.alt = title;
        if (thumbUrl) img.src = thumbUrl;
        card.appendChild(img);

        const content = document.createElement('div');
        content.className = 'portfolio-feed-content';

        const h3 = document.createElement('h3');
        h3.textContent = title;
        content.appendChild(h3);

        if (description) {
          const p = document.createElement('p');
          p.textContent = description;
          content.appendChild(p);
        }

        if (category) {
          const tags = document.createElement('div');
          tags.className = 'portfolio-feed-tags';
          const span = document.createElement('span');
          span.textContent = category;
          tags.appendChild(span);
          content.appendChild(tags);
        }

        const likeRow = document.createElement('div');
        likeRow.className = 'like-row';

        const count = document.createElement('span');
        count.className = 'like-count';
        count.textContent = `${likeCount.toLocaleString()} like${likeCount === 1 ? '' : 's'}`;
        likeRow.appendChild(count);

        const likeStatus = document.createElement('span');
        likeStatus.className = 'like-status';
        likeStatus.setAttribute('aria-live', 'polite');
        likeStatus.style.marginLeft = '10px';
        likeStatus.style.color = '#bbb';
        likeStatus.style.fontSize = '0.9rem';
        likeStatus.textContent = '';
        likeRow.appendChild(likeStatus);

        const btn = document.createElement('button');
        btn.className = 'like-btn' + (liked ? ' liked' : '');
        btn.type = 'button';
        setLikeButtonVisual(btn, liked);
        btn.addEventListener('click', async (e) => {
          e.preventDefault();
          e.stopPropagation();

          likeStatus.textContent = '';

          if (id && userLikes && userLikes[id] === true) {
            // One-like-only: don't allow toggling/unlike.
            likeStatus.textContent = 'You already liked this post.';
            setTimeout(() => {
              if (likeStatus) likeStatus.textContent = '';
            }, 2200);
            return;
          }

          if (!id) return;
          if (!currentUser) {
            window.location.href = '../user/login.html';
            return;
          }

          btn.disabled = true;
          try {
            const res = await toggleLikeCallable({ photoId: id });
            const data = res && res.data ? res.data : {};
            const nextLiked = data.liked === true;
            const prevLiked = !!(userLikes && userLikes[id] === true);
            applyLocalLikeUpdate(id, nextLiked, data.likeCount);
            setLikeButtonVisual(btn, nextLiked);
            if (Number.isFinite(Number(data.likeCount))) {
              const n = Number(data.likeCount);
              count.textContent = `${n.toLocaleString()} like${n === 1 ? '' : 's'}`;
            }

            // Notify admin only on a new like (not on unlike).
            if (!prevLiked && nextLiked) {
              sendLikeNotificationCallable({ photoId: id }).catch((err) => {
                console.warn('Like notification failed:', err);
              });
            }

            // Keep the grid consistent immediately.
            renderPortfolio();

            if (data.alreadyLiked === true) {
              likeStatus.textContent = 'You already liked this post.';
              setTimeout(() => {
                if (likeStatus) likeStatus.textContent = '';
              }, 2200);
            }
          } catch (err) {
            console.error('Like toggle failed:', err);
          } finally {
            btn.disabled = false;
          }
        });
        likeRow.appendChild(btn);

        const commentBtn = document.createElement('button');
        commentBtn.className = 'like-btn';
        commentBtn.type = 'button';
        commentBtn.innerHTML = '<i class="fas fa-comment"></i> Comment';
        commentBtn.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          open({ openComments: true });
        });
        likeRow.appendChild(commentBtn);
        content.appendChild(likeRow);

        card.appendChild(content);
        return card;
      }

      function createComingSoonCard() {
        const wrap = document.createElement('div');
        wrap.className = 'portfolio-feed-item is-placeholder';
        wrap.setAttribute('aria-label', 'New work coming soon');

        const hero = document.createElement('div');
        hero.className = 'portfolio-placeholder-hero';
        hero.innerHTML = '<i class="fas fa-hourglass-half" aria-hidden="true"></i> New work coming soon';
        wrap.appendChild(hero);

        const content = document.createElement('div');
        content.className = 'portfolio-feed-content';

        const h3 = document.createElement('h3');
        h3.textContent = 'New work coming soon';
        content.appendChild(h3);

        const p = document.createElement('p');
        p.textContent = 'I’m actively adding new projects. Check back soon.';
        content.appendChild(p);

        const tags = document.createElement('div');
        tags.className = 'portfolio-feed-tags';
        const span = document.createElement('span');
        span.textContent = 'Coming Soon';
        tags.appendChild(span);
        content.appendChild(tags);

        wrap.appendChild(content);
        return wrap;
      }

      function ensurePortfolioModal() {
        const { overlay, closeBtn, carouselEl, prevBtn, nextBtn, likeBtn, commentBtn, commentsPanel, commentSend, commentInput, commentStatus, actionStatus } = getModalEls();
        if (!overlay || !closeBtn || !carouselEl || !prevBtn || !nextBtn) return;

        if (overlay.getAttribute('data-wired') === 'true') return;
        overlay.setAttribute('data-wired', 'true');

        const close = () => closePortfolioModal();

        closeBtn.addEventListener('click', close);
        overlay.addEventListener('click', (e) => {
          if (e.target === overlay) close();
        });
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') close();

          if (!overlay.classList.contains('open')) return;
          if (e.key === 'ArrowLeft') {
            e.preventDefault();
            scrollModalToIndex(modalCarouselIndex - 1);
          }
          if (e.key === 'ArrowRight') {
            e.preventDefault();
            scrollModalToIndex(modalCarouselIndex + 1);
          }
        });

        prevBtn.addEventListener('click', () => scrollModalToIndex(modalCarouselIndex - 1));
        nextBtn.addEventListener('click', () => scrollModalToIndex(modalCarouselIndex + 1));

        if (likeBtn) {
          likeBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            if (actionStatus) actionStatus.textContent = '';
            const id = (typeof modalItemId === 'string') ? modalItemId : '';
            if (!id) return;
            if (!currentUser) {
              window.location.href = '../user/login.html';
              return;
            }

            if (userLikes && userLikes[id] === true) {
              // One-like-only: don't allow toggling/unlike.
              setLikeButtonVisual(likeBtn, true);
              if (actionStatus) actionStatus.textContent = 'You already liked this post.';
              return;
            }

            likeBtn.disabled = true;
            try {
              const res = await toggleLikeCallable({ photoId: id });
              const data = res && res.data ? res.data : {};
              const nextLiked = data.liked === true;
              const prevLiked = !!(userLikes && userLikes[id] === true);
              applyLocalLikeUpdate(id, nextLiked, data.likeCount);
              setLikeButtonVisual(likeBtn, nextLiked);

              if (Number.isFinite(Number(data.likeCount))) {
                const n = Number(data.likeCount);
                const { likeEl } = getModalEls();
                if (likeEl) likeEl.textContent = `${n.toLocaleString()} like${n === 1 ? '' : 's'}`;
              }

              if (!prevLiked && nextLiked) {
                sendLikeNotificationCallable({ photoId: id }).catch((err) => {
                  console.warn('Like notification failed:', err);
                });
              }

              // Re-render grid so the card button state stays in sync.
              renderPortfolio();

              if (data.alreadyLiked === true && actionStatus) {
                actionStatus.textContent = 'You already liked this post.';
              }
            } catch (err) {
              console.error('Modal like failed:', err);
              const code = (err && typeof err.code === 'string') ? err.code : '';
              if (code.includes('unauthenticated')) {
                if (actionStatus) actionStatus.textContent = 'Please log in again to like.';
              } else if (code.includes('permission-denied')) {
                if (actionStatus) actionStatus.textContent = 'Likes are blocked (Cloud Functions permission/App Check).';
              } else if (code.includes('not-found')) {
                if (actionStatus) actionStatus.textContent = 'Like service not deployed yet.';
              } else {
                if (actionStatus) actionStatus.textContent = 'Could not like right now. Please try again.';
              }
            } finally {
              likeBtn.disabled = false;
            }
          });
        }

        if (commentBtn && commentsPanel) {
          commentBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            const open = commentsPanel.classList.toggle('open');
            if (open) {
              await loadModalComments();
              renderModalCommentsFull();
              try { if (commentInput) commentInput.focus(); } catch {}
            }
          });
        }

        const { commentsPreviewMore } = getModalEls();
        if (commentsPreviewMore && commentsPanel) {
          commentsPreviewMore.addEventListener('click', async (e) => {
            e.preventDefault();
            commentsPanel.classList.add('open');
            await loadModalComments();
            renderModalCommentsFull();
            try { if (commentInput) commentInput.focus(); } catch {}
          });
        }

        if (commentSend) {
          commentSend.addEventListener('click', async (e) => {
            e.preventDefault();
            const id = (typeof modalItemId === 'string') ? modalItemId : '';
            if (!id) return;
            if (!currentUser) {
              window.location.href = '../user/login.html';
              return;
            }

            const text = commentInput && typeof commentInput.value === 'string' ? commentInput.value.trim() : '';
            if (!text) return;
            if (text.length > 500) {
              if (commentStatus) commentStatus.textContent = 'Comment is too long (max 500 characters).';
              return;
            }

            commentSend.disabled = true;
            if (commentStatus) commentStatus.textContent = 'Posting…';
            try {
              await addCommentCallable({ photoId: id, text });
              if (commentInput) commentInput.value = '';
              if (commentStatus) commentStatus.textContent = '';
              await loadModalComments();
              renderModalCommentsFull();
            } catch (err) {
              console.warn('Comment post failed:', err);
              const code = (err && typeof err.code === 'string') ? err.code : '';
              if (code.includes('unauthenticated')) {
                if (commentStatus) commentStatus.textContent = 'Please log in again to comment.';
              } else if (code.includes('permission-denied')) {
                if (commentStatus) commentStatus.textContent = 'Comments are blocked (Cloud Functions permission/App Check).';
              } else if (code.includes('not-found')) {
                if (commentStatus) commentStatus.textContent = 'Comments service not deployed yet.';
              } else {
                if (commentStatus) commentStatus.textContent = 'Could not post comment right now.';
              }
            } finally {
              commentSend.disabled = false;
            }
          });
        }

        // Optional: Shift+wheel scrolls the carousel horizontally (keeps normal vertical scrolling intact).
        carouselEl.addEventListener('wheel', (e) => {
          if (!overlay.classList.contains('open')) return;
          if (!e.shiftKey) return;
          const canScroll = carouselEl.scrollWidth > (carouselEl.clientWidth + 2);
          if (!canScroll) return;

          const dy = Number(e.deltaY) || 0;
          if (!dy) return;
          e.preventDefault();
          carouselEl.scrollLeft += dy;
        }, { passive: false });

        // Pointer-drag swipe (desktop + touch fallback).
        let isDown = false;
        let startX = 0;
        let startLeft = 0;

        const endDrag = () => {
          if (!isDown) return;
          isDown = false;
          carouselEl.classList.remove('dragging');
        };

        carouselEl.addEventListener('pointerdown', (e) => {
          if (!overlay.classList.contains('open')) return;
          if (e.button !== undefined && e.button !== 0) return;
          // Only enable drag-to-scroll for mouse. Touch should keep native vertical scroll working.
          if (e.pointerType && e.pointerType !== 'mouse') return;
          const canScroll = carouselEl.scrollWidth > (carouselEl.clientWidth + 2);
          if (!canScroll) return;

          isDown = true;
          startX = Number(e.clientX) || 0;
          startLeft = carouselEl.scrollLeft || 0;
          carouselEl.classList.add('dragging');
          try { carouselEl.setPointerCapture(e.pointerId); } catch {}
        });

        carouselEl.addEventListener('pointermove', (e) => {
          if (!isDown) return;
          const x = Number(e.clientX) || 0;
          const dx = x - startX;
          carouselEl.scrollLeft = startLeft - dx;
        });

        carouselEl.addEventListener('pointerup', endDrag);
        carouselEl.addEventListener('pointercancel', endDrag);
        carouselEl.addEventListener('pointerleave', endDrag);

        carouselEl.addEventListener('scroll', () => {
          if (!overlay.classList.contains('open')) return;
          if (modalScrollRaf) cancelAnimationFrame(modalScrollRaf);
          modalScrollRaf = requestAnimationFrame(() => {
            modalScrollRaf = 0;
            const w = carouselEl.clientWidth || 1;
            const idx = clamp(Math.round((carouselEl.scrollLeft || 0) / w), 0, Math.max(0, modalCarouselUrls.length - 1));
            if (idx !== modalCarouselIndex) {
              modalCarouselIndex = idx;
              updateModalNavState();
            }
          });
        }, { passive: true });
      }

      function openPortfolioModal(item) {
        ensurePortfolioModal();

        const { overlay, titleEl, carouselEl, descEl, tagsEl, likeEl, likeBtn, thumbsEl, commentsPanel, commentStatus, commentList, actionStatus } = getModalEls();
        if (!overlay || !titleEl || !carouselEl || !descEl || !tagsEl || !likeEl || !thumbsEl) return;

        modalItemId = (item && typeof item.id === 'string') ? item.id : '';
        modalCommentsCache = [];

        modalCarouselTitle = item && item.title ? String(item.title) : '';
        titleEl.textContent = modalCarouselTitle;

        const urlsRaw = Array.isArray(item && item.imageUrls)
          ? item.imageUrls
          : (item && item.imageUrl ? [item.imageUrl] : []);
        const urls = urlsRaw
          .map((u) => normalizeHttpUrl(u))
          .filter(Boolean)
          .slice(0, 10);

        const thumbsRaw = Array.isArray(item && item.thumbUrls)
          ? item.thumbUrls
          : [];
        const thumbsNorm = thumbsRaw
          .map((u) => normalizeHttpUrl(u))
          .filter(Boolean)
          .slice(0, 10);
        const thumbs = (thumbsNorm.length >= urls.length)
          ? thumbsNorm.slice(0, urls.length)
          : thumbsNorm.concat(urls.slice(thumbsNorm.length));

        modalCarouselUrls = urls;
        modalCarouselThumbs = thumbs;
        modalCarouselIndex = 0;

        carouselEl.innerHTML = '';
        thumbsEl.innerHTML = '';

        if (urls.length) {
          urls.forEach((url, idx) => {
            const slide = document.createElement('div');
            slide.className = 'portfolio-modal-slide';

            const img = document.createElement('img');
            img.alt = modalCarouselTitle || 'Portfolio image';
            img.decoding = 'async';
            img.loading = idx === 0 ? 'eager' : 'lazy';
            img.src = url;

            slide.appendChild(img);
            carouselEl.appendChild(slide);
          });

          urls.forEach((url, idx) => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'portfolio-modal-thumb' + (idx === 0 ? ' active' : '');
            btn.setAttribute('aria-label', `View image ${idx + 1}`);

            const timg = document.createElement('img');
            timg.alt = '';
            timg.loading = 'lazy';
            timg.src = thumbs[idx] || url;
            btn.appendChild(timg);

            btn.addEventListener('click', () => {
              scrollModalToIndex(idx);
            });

            thumbsEl.appendChild(btn);
          });

          thumbsEl.style.display = urls.length > 1 ? '' : 'none';

          // Ensure we start at the first image.
          requestAnimationFrame(() => scrollModalToIndex(0, 'auto'));
        } else {
          carouselEl.innerHTML = '';
          thumbsEl.style.display = 'none';
          modalCarouselUrls = [];
          modalCarouselThumbs = [];
          modalCarouselIndex = 0;
        }

        updateModalNavState();

        const desc = item && item.description ? String(item.description) : '';
        descEl.textContent = desc;
        descEl.style.display = desc.trim().length ? '' : 'none';

        tagsEl.innerHTML = '';
        const cat = item && item.category ? String(item.category) : '';
        if (cat.trim().length) {
          const span = document.createElement('span');
          span.textContent = cat;
          tagsEl.appendChild(span);
          tagsEl.style.display = '';
        } else {
          tagsEl.style.display = 'none';
        }

        const n = Number.isFinite(Number(item && item.likeCount)) ? Number(item.likeCount) : 0;
        likeEl.textContent = `${n.toLocaleString()} like${n === 1 ? '' : 's'}`;

        if (likeBtn) {
          const liked = !!(modalItemId && userLikes && userLikes[modalItemId] === true);
          setLikeButtonVisual(likeBtn, liked);
        }

        if (commentsPanel) commentsPanel.classList.remove('open');
        if (commentStatus) commentStatus.textContent = '';
        if (commentList) commentList.innerHTML = '';
        if (actionStatus) actionStatus.textContent = '';

        const { commentsPreviewStatus, commentsPreviewList, commentsPreviewMore } = getModalEls();
        if (commentsPreviewStatus) commentsPreviewStatus.textContent = '';
        if (commentsPreviewList) commentsPreviewList.innerHTML = '';
        if (commentsPreviewMore) commentsPreviewMore.style.display = 'none';

        overlay.classList.add('open');
        overlay.setAttribute('aria-hidden', 'false');
        document.documentElement.style.overflow = 'hidden';

        // Load a small preview immediately so users can see comments without tapping Comment.
        loadModalComments();

        if (commentsPanel && item && item.openComments === true) {
          commentsPanel.classList.add('open');
          loadModalComments().then(() => {
            renderModalCommentsFull();
          });
        }
      }

      function closePortfolioModal() {
        const overlay = document.getElementById('portfolioModalOverlay');
        if (!overlay) return;
        overlay.classList.remove('open');
        overlay.setAttribute('aria-hidden', 'true');
        document.documentElement.style.overflow = '';
        modalItemId = '';
        modalCommentsCache = [];
      }

      function renderPortfolio() {
        const grid = document.getElementById('portfolioGrid');
        if (!grid) return;
        clearElement(grid);

        if (!Array.isArray(portfolioItems) || portfolioItems.length === 0) {
          // Show a single placeholder card when there are no posts.
          grid.appendChild(createComingSoonCard());
          return;
        }

        for (const item of portfolioItems) {
          const card = createCard(item);
          if (card) grid.appendChild(card);
        }
      }

      function wireFollowButton() {
        const btn = document.getElementById('followBtn');
        if (!btn) return;
        btn.addEventListener('click', async (e) => {
          e.preventDefault();
          if (!currentUser) {
            window.location.href = '../user/login.html';
            return;
          }

          const prevFollowing = isFollowing;
          btn.disabled = true;
          try {
            const res = await setFollowingCallable({ following: !isFollowing });
            const data = res && res.data ? res.data : {};
            isFollowing = data.following === true;
            setFollowButtonState();
            if (Number.isFinite(Number(data.followers))) setFollowersCount(Number(data.followers));

            // Notify admin only on a new follow (not on unfollow).
            if (!prevFollowing && isFollowing) {
              sendFollowNotificationCallable({}).catch((err) => {
                console.warn('Follow notification failed:', err);
              });
            }
          } catch (err) {
            console.error('Follow toggle failed:', err);
          } finally {
            btn.disabled = false;
          }
        });
      }

      function subscribePortfolio() {
        setStatus('Loading portfolio…');
        db.collection('portfolio').orderBy('createdAt', 'desc').onSnapshot((snap) => {
          portfolioItems = [];
          snap.forEach((doc) => portfolioItems.push({ id: doc.id, ...doc.data() }));

          if (portfolioItems.length === 0) setStatus('New work coming soon.');
          else setStatus('');
          renderPortfolio();
        }, (err) => {
          console.error('Portfolio subscription error:', err);
          setStatus('Could not load portfolio right now.');
        });
      }

      function subscribeProfile() {
        db.collection('profile').doc('dominic').onSnapshot((doc) => {
          const data = doc.exists ? doc.data() : {};
          setFollowersCount(data && data.followers);
        });
      }

      function subscribeCurrentUserDoc(uid) {
        return db.collection('users').doc(uid).onSnapshot((doc) => {
          const data = doc.exists ? doc.data() : {};
          userLikes = (data && typeof data.likes === 'object' && data.likes) ? data.likes : {};
          isFollowing = data && data.isFollowingDominic === true;
          setFollowButtonState();
          renderPortfolio();
        }, (err) => {
          console.error('User doc subscription error:', err);

          // If rules block reading the user doc, fall back to a callable so the
          // UI still knows which posts are already liked.
          const code = (err && typeof err.code === 'string') ? err.code : '';
          if (code.includes('permission-denied') || code.includes('PERMISSION_DENIED')) {
            getCurrentUserLikesCallable({}).then((res) => {
              const data = res && res.data ? res.data : {};
              if (data && typeof data.likes === 'object' && data.likes) {
                userLikes = data.likes;
                renderPortfolio();
              }
            }).catch((e) => {
              console.warn('getCurrentUserLikes fallback failed:', e);
            });
          }
        });
      }

      window.addEventListener('load', () => {
        wireFollowButton();
        subscribeProfile();
        subscribePortfolio();

        let unsubscribeUser = null;
        auth.onAuthStateChanged((user) => {
          currentUser = user || null;
          userLikes = {};
          isFollowing = false;
          setFollowButtonState();

          if (unsubscribeUser) {
            try { unsubscribeUser(); } catch { /* noop */ }
            unsubscribeUser = null;
          }

          if (currentUser) {
            unsubscribeUser = subscribeCurrentUserDoc(currentUser.uid);

            // Also pull likes via callable once on sign-in to ensure like state
            // is correct even before the Firestore user doc snapshot arrives.
            getCurrentUserLikesCallable({}).then((res) => {
              const data = res && res.data ? res.data : {};
              if (data && typeof data.likes === 'object' && data.likes) {
                userLikes = data.likes;
                renderPortfolio();
              }
            }).catch(() => {
              // Silent: Firestore subscription may still provide likes.
            });
          } else {
            renderPortfolio();
          }
        });
      });
    })();
  </script>
</body>
</html>
