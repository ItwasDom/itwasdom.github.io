<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; base-uri 'self'; object-src 'none'; frame-ancestors 'none'; form-action 'self'; img-src 'self' data: https:; style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; font-src 'self' https://cdnjs.cloudflare.com data:; script-src 'self' 'unsafe-inline' https://www.gstatic.com https://www.googleapis.com https://cdnjs.cloudflare.com; script-src-attr 'none'; connect-src 'self' https://*.googleapis.com https://*.firebaseio.com https://www.googleapis.com https://*.cloudfunctions.net;">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Portfolio - Dominic Martinez</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
  <link rel="stylesheet" href="../styles.css">
  <style>
    .portfolio-page-container {
      max-width: 1200px;
      margin: 120px auto 60px;
      padding: 0 20px;
    }

    .back-to-home {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      color: #7C3AED;
      text-decoration: none;
      font-weight: 600;
      margin-bottom: 40px;
      transition: all 0.3s ease;
    }

    .back-to-home:hover {
      transform: translateX(-5px);
    }

    .portfolio-title {
      font-size: 2.8rem;
      text-align: center;
      background: linear-gradient(135deg, #1B16A8 0%, #7C3AED 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 50px;
      font-weight: 800;
    }

    .portfolio-feed-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 24px;
      margin-bottom: 60px;
      max-width: 1100px;
      margin-left: auto;
      margin-right: auto;
    }

    .portfolio-feed-item {
      background: linear-gradient(135deg, rgba(27, 22, 168, 0.12) 0%, rgba(124, 58, 237, 0.12) 100%);
      border-radius: 18px;
      overflow: hidden;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      cursor: pointer;
      border: 1px solid rgba(124, 58, 237, 0.28);
      text-decoration: none;
      color: inherit;
      display: flex;
      flex-direction: column;
      animation: fadeInBounce 0.8s ease-out;
      position: relative;
    }

    .portfolio-feed-item:hover {
      transform: translateY(-12px) scale(1.02);
      box-shadow: 0 20px 50px rgba(124, 58, 237, 0.3);
      border-color: rgba(124, 58, 237, 0.55);
    }

    .portfolio-feed-item img {
      width: 100%;
      height: 280px;
      object-fit: cover;
      transition: all 0.4s ease-in-out;
      filter: brightness(0.9);
      display: block;
      border-radius: 16px;
      margin: 0;
      padding: 0;
    }

    .portfolio-feed-item:hover img {
      filter: brightness(1.1) contrast(1.1);
      transform: scale(1.15);
      height: 320px;
    }

    .portfolio-feed-content {
      padding: 18px;
      background: rgba(15, 15, 15, 0.9);
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
      transition: all 0.3s ease-in-out;
      opacity: 0.85;
    }

    .portfolio-feed-content h3 {
      font-size: 1.1rem;
      color: #7C3AED;
      margin: 0;
      font-weight: 700;
    }

    .portfolio-feed-content p {
      font-size: 0.85rem;
      color: #aaa;
      margin: 0;
      line-height: 1.4;
      flex-grow: 1;
    }

    .portfolio-feed-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .portfolio-feed-tags span {
      background: rgba(124, 58, 237, 0.2);
      color: #7C3AED;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      border: 1px solid rgba(124, 58, 237, 0.3);
      transition: all 0.3s ease-in-out;
    }

    .portfolio-feed-tags span:hover {
      background: rgba(124, 58, 237, 0.35);
      border-color: rgba(124, 58, 237, 0.6);
    }

    .portfolio-footer-message {
      text-align: center;
      color: #999;
      font-size: 1.1rem;
      padding: 40px 20px;
      border-top: 1px solid rgba(124, 58, 237, 0.22);
      margin-top: 40px;
    }

    .portfolio-actions {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 14px;
      margin: -25px 0 35px;
      flex-wrap: wrap;
    }

    .follow-btn {
      padding: 10px 16px;
      border-radius: 999px;
      border: 2px solid #7C3AED;
      background: transparent;
      color: #7C3AED;
      cursor: pointer;
      font-weight: 700;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .follow-btn.following {
      background: rgba(124, 58, 237, 0.16);
    }

    .followers-count {
      color: #aaa;
      font-size: 0.95rem;
    }

    .like-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
    }

    .like-count {
      color: #aaa;
      font-size: 0.85rem;
    }

    .like-btn {
      border: 2px solid rgba(124, 58, 237, 0.55);
      background: transparent;
      color: #7C3AED;
      border-radius: 999px;
      padding: 8px 12px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-weight: 700;
      font-size: 0.85rem;
    }

    .like-btn.liked {
      background: rgba(124, 58, 237, 0.18);
    }

    @media (max-width: 768px) {
      .portfolio-page-container {
        margin-top: 100px;
      }

      .portfolio-title {
        font-size: 2rem;
      }

      .portfolio-feed-grid {
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
      }

      .portfolio-feed-item {
      }

      .portfolio-feed-item img {
        height: 200px;
      }

      .portfolio-feed-item:hover img {
        height: 240px;
      }

      .portfolio-feed-content {
        padding: 16px;
      }

      .portfolio-feed-content h3 {
        font-size: 1rem;
      }

      .portfolio-feed-content p {
        font-size: 0.8rem;
      }
    }

    /* ===== Portfolio Details Modal ===== */
    .portfolio-modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.75);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 22px;
      z-index: 2000;
    }

    .portfolio-modal-overlay.open {
      display: flex;
    }

    .portfolio-modal {
      width: min(980px, 100%);
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      border: 1px solid rgba(124, 58, 237, 0.35);
      border-radius: 18px;
      box-shadow: 0 30px 80px rgba(0, 0, 0, 0.6);
      overflow: hidden;
      max-height: 90vh;
      display: grid;
      grid-template-columns: 1.2fr 1fr;
    }

    .portfolio-modal-media {
      background: #0b0b12;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 320px;
      position: relative;
    }

    .portfolio-modal-media img {
      width: 100%;
      height: 100%;
      max-height: 90vh;
      object-fit: contain;
      display: block;
    }

    .portfolio-modal-thumbs {
      display: flex;
      gap: 10px;
      padding: 12px;
      border-top: 1px solid rgba(124, 58, 237, 0.18);
      overflow-x: auto;
      background: rgba(0, 0, 0, 0.12);
    }

    .portfolio-modal-thumb {
      width: 84px;
      height: 64px;
      border-radius: 10px;
      border: 2px solid rgba(124, 58, 237, 0.25);
      background: #0b0b12;
      overflow: hidden;
      cursor: pointer;
      flex: 0 0 auto;
      padding: 0;
    }

    .portfolio-modal-thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      filter: brightness(0.9);
    }

    .portfolio-modal-thumb.active {
      border-color: rgba(124, 58, 237, 0.85);
      box-shadow: 0 10px 30px rgba(124, 58, 237, 0.18);
    }

    .portfolio-modal-body {
      padding: 22px;
      overflow: auto;
    }

    .portfolio-modal-top {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 14px;
      margin-bottom: 12px;
    }

    .portfolio-modal-title {
      font-size: 1.4rem;
      font-weight: 800;
      color: #f0f0f0;
      margin: 0;
      line-height: 1.2;
    }

    .portfolio-modal-close {
      border: 2px solid rgba(124, 58, 237, 0.55);
      background: transparent;
      color: #7C3AED;
      border-radius: 10px;
      width: 42px;
      height: 42px;
      cursor: pointer;
      font-weight: 800;
    }

    .portfolio-modal-desc {
      color: #bbb;
      font-size: 0.95rem;
      line-height: 1.7;
      margin: 10px 0 14px;
      white-space: pre-wrap;
    }

    .portfolio-modal-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 10px 0 14px;
    }

    .portfolio-modal-tags span {
      background: rgba(124, 58, 237, 0.2);
      color: #7C3AED;
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 0.8rem;
      font-weight: 700;
      border: 1px solid rgba(124, 58, 237, 0.3);
    }

    .portfolio-modal-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-top: 14px;
      flex-wrap: wrap;
    }

    .portfolio-modal-open {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      border-radius: 999px;
      border: 2px solid rgba(124, 58, 237, 0.55);
      background: transparent;
      color: #7C3AED;
      font-weight: 800;
      text-decoration: none;
    }

    @media (max-width: 860px) {
      .portfolio-modal {
        grid-template-columns: 1fr;
      }
      .portfolio-modal-body {
        padding: 18px;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <div class="logo"><a href="../index.html" style="text-decoration: none; color: inherit;">Dominic Martinez</a></div>
      <nav>
        <ul class="nav-links">
          <li><a href="../about/index.html">About</a></li>
          <li><a href="../experience/index.html">Experience</a></li>
          <li><a href="../skills/index.html">Skills</a></li>
          <li><a href="../portfolio/index.html">Portfolio</a></li>
          <li><a href="../connect/index.html">Connect</a></li>
          <li class="auth-nav-item">
            <a id="authNavBtn" href="../user/login.html" class="login-nav-btn">Login / Sign Up</a>
            <div id="authDropdown" class="auth-dropdown">
              <a id="authDashboardLink" href="../user/dashboard.html">My Dashboard</a>
              <a href="#" id="authLogoutBtn">Logout</a>
            </div>
          </li>
        </ul>
      </nav>
    </div>
  </header>

  <div class="portfolio-page-container">
    <a href="../index.html#portfolio" class="back-to-home">
      <i class="fas fa-arrow-left"></i>
      Back to Home
    </a>

    <h1 class="portfolio-title">My Work</h1>

    <div class="portfolio-actions">
      <button id="followBtn" class="follow-btn" type="button">
        <i class="fas fa-user-plus"></i>
        <span id="followBtnText">Follow</span>
      </button>
      <span id="followersCount" class="followers-count"></span>
    </div>

    <div class="portfolio-feed-grid" id="portfolioGrid" aria-live="polite"></div>

    <div class="portfolio-footer-message" id="portfolioStatus">Loading portfolio…</div>

    <div class="portfolio-footer-message">
      <p>Interested in a project? <a href="../index.html#connect" style="color: #7C3AED; text-decoration: none; font-weight: 600;">Get in touch</a></p>
    </div>
  </div>

  <!-- Portfolio details modal -->
  <div id="portfolioModalOverlay" class="portfolio-modal-overlay" aria-hidden="true">
    <div class="portfolio-modal" role="dialog" aria-modal="true" aria-labelledby="portfolioModalTitle">
      <div>
        <div class="portfolio-modal-media">
          <img id="portfolioModalImage" alt="" />
        </div>
        <div id="portfolioModalThumbs" class="portfolio-modal-thumbs" aria-label="Project images"></div>
      </div>
      <div class="portfolio-modal-body">
        <div class="portfolio-modal-top">
          <h2 id="portfolioModalTitle" class="portfolio-modal-title"></h2>
          <button id="portfolioModalClose" class="portfolio-modal-close" type="button" aria-label="Close">
            <i class="fas fa-times"></i>
          </button>
        </div>

        <div id="portfolioModalTags" class="portfolio-modal-tags"></div>
        <p id="portfolioModalDesc" class="portfolio-modal-desc"></p>

        <div class="portfolio-modal-actions">
          <span id="portfolioModalLikeCount" class="like-count"></span>
          <a id="portfolioModalOpenImage" class="portfolio-modal-open" href="#" target="_blank" rel="noopener noreferrer">
            <i class="fas fa-arrow-up-right-from-square"></i> Open Image
          </a>
        </div>
      </div>
    </div>
  </div>

  <footer>
    <div class="container">
      &copy; 2026 Dominic Martinez. All rights reserved.
    </div>
  </footer>

  <!-- Firebase (for auth-aware nav) -->
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-functions-compat.js"></script>
  <script src="/assets/js/firebase-config.js"></script>
  <script src="/assets/js/firebase-init-compat.js"></script>
  <script src="/assets/js/auth-nav.js"></script>

  <script>
    (function () {
      const auth = firebase.auth();
      const db = firebase.firestore();
      const fns = firebase.functions();
      const toggleLikeCallable = fns.httpsCallable('togglePortfolioLike');
      const setFollowingCallable = fns.httpsCallable('setFollowingDominic');
      const sendLikeNotificationCallable = fns.httpsCallable('sendLikeNotification');
      const sendFollowNotificationCallable = fns.httpsCallable('sendFollowNotification');

      let currentUser = null;
      let userLikes = {};
      let isFollowing = false;
      let portfolioItems = [];

      function normalizeHttpUrl(url) {
        if (typeof url !== 'string') return null;
        try {
          const u = new URL(url, window.location.href);
          if (u.protocol !== 'http:' && u.protocol !== 'https:') return null;
          return u.href;
        } catch {
          return null;
        }
      }

      function clearElement(el) {
        if (!el) return;
        while (el.firstChild) el.removeChild(el.firstChild);
      }

      function setStatus(text) {
        const statusEl = document.getElementById('portfolioStatus');
        if (statusEl) statusEl.textContent = text;
      }

      function setFollowersCount(n) {
        const el = document.getElementById('followersCount');
        if (!el) return;
        const num = Number.isFinite(Number(n)) ? Number(n) : 0;
        el.textContent = `${num.toLocaleString()} follower${num === 1 ? '' : 's'}`;
      }

      function setFollowButtonState() {
        const btn = document.getElementById('followBtn');
        const text = document.getElementById('followBtnText');
        if (!btn || !text) return;

        if (!currentUser) {
          btn.classList.remove('following');
          text.textContent = 'Follow';
          return;
        }

        if (isFollowing) {
          btn.classList.add('following');
          text.textContent = 'Following';
        } else {
          btn.classList.remove('following');
          text.textContent = 'Follow';
        }
      }

      function createCard(item) {
        const imageUrlsRaw = Array.isArray(item && item.imageUrls)
          ? item.imageUrls
          : (item && item.imageUrl ? [item.imageUrl] : []);
        const imageUrls = imageUrlsRaw.map((u) => normalizeHttpUrl(u)).filter(Boolean).slice(0, 10);
        const imageUrl = imageUrls.length ? imageUrls[0] : null;
        const title = (item && typeof item.title === 'string' && item.title.trim()) ? item.title.trim() : 'Untitled';
        const description = (item && typeof item.description === 'string' && item.description.trim()) ? item.description.trim() : '';
        const category = (item && typeof item.category === 'string' && item.category.trim()) ? item.category.trim() : '';
        const id = (item && typeof item.id === 'string' && item.id.trim()) ? item.id.trim() : '';
        const likeCountRaw = item && item.likeCount;
        const likeCount = Number.isFinite(Number(likeCountRaw)) ? Number(likeCountRaw) : 0;
        const liked = !!(id && userLikes && userLikes[id] === true);

        const a = document.createElement('a');
        a.className = 'portfolio-feed-item';
        a.setAttribute('aria-label', title);

        a.href = '#';
        a.addEventListener('click', (e) => {
          e.preventDefault();
          openPortfolioModal({
            id,
            title,
            description,
            category,
            imageUrl,
            imageUrls,
            likeCount,
          });
        });

        const img = document.createElement('img');
        img.loading = 'lazy';
        img.alt = title;
        if (imageUrl) img.src = imageUrl;
        a.appendChild(img);

        const content = document.createElement('div');
        content.className = 'portfolio-feed-content';

        const h3 = document.createElement('h3');
        h3.textContent = title;
        content.appendChild(h3);

        if (description) {
          const p = document.createElement('p');
          p.textContent = description;
          content.appendChild(p);
        }

        if (category) {
          const tags = document.createElement('div');
          tags.className = 'portfolio-feed-tags';
          const span = document.createElement('span');
          span.textContent = category;
          tags.appendChild(span);
          content.appendChild(tags);
        }

        const likeRow = document.createElement('div');
        likeRow.className = 'like-row';

        const count = document.createElement('span');
        count.className = 'like-count';
        count.textContent = `${likeCount.toLocaleString()} like${likeCount === 1 ? '' : 's'}`;
        likeRow.appendChild(count);

        const btn = document.createElement('button');
        btn.className = 'like-btn' + (liked ? ' liked' : '');
        btn.type = 'button';
        btn.innerHTML = '<i class="fas fa-heart"></i> Like';
        btn.addEventListener('click', async (e) => {
          e.preventDefault();
          e.stopPropagation();

          if (!id) return;
          if (!currentUser) {
            window.location.href = '../user/login.html';
            return;
          }

          btn.disabled = true;
          try {
            const res = await toggleLikeCallable({ photoId: id });
            const data = res && res.data ? res.data : {};
            const nextLiked = data.liked === true;
            const prevLiked = !!(userLikes && userLikes[id] === true);
            userLikes = { ...(userLikes || {}), [id]: nextLiked };
            btn.classList.toggle('liked', nextLiked);
            if (Number.isFinite(Number(data.likeCount))) {
              const n = Number(data.likeCount);
              count.textContent = `${n.toLocaleString()} like${n === 1 ? '' : 's'}`;
            }

            // Notify admin only on a new like (not on unlike).
            if (!prevLiked && nextLiked) {
              sendLikeNotificationCallable({ photoId: id }).catch((err) => {
                console.warn('Like notification failed:', err);
              });
            }
          } catch (err) {
            console.error('Like toggle failed:', err);
          } finally {
            btn.disabled = false;
          }
        });
        likeRow.appendChild(btn);
        content.appendChild(likeRow);

        a.appendChild(content);
        return a;
      }

      function ensurePortfolioModal() {
        const overlay = document.getElementById('portfolioModalOverlay');
        const closeBtn = document.getElementById('portfolioModalClose');
        if (!overlay || !closeBtn) return;

        if (overlay.getAttribute('data-wired') === 'true') return;
        overlay.setAttribute('data-wired', 'true');

        const close = () => closePortfolioModal();

        closeBtn.addEventListener('click', close);
        overlay.addEventListener('click', (e) => {
          if (e.target === overlay) close();
        });
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') close();
        });
      }

      function openPortfolioModal(item) {
        ensurePortfolioModal();

        const overlay = document.getElementById('portfolioModalOverlay');
        const titleEl = document.getElementById('portfolioModalTitle');
        const imgEl = document.getElementById('portfolioModalImage');
        const descEl = document.getElementById('portfolioModalDesc');
        const tagsEl = document.getElementById('portfolioModalTags');
        const likeEl = document.getElementById('portfolioModalLikeCount');
        const openLink = document.getElementById('portfolioModalOpenImage');
        const thumbsEl = document.getElementById('portfolioModalThumbs');

        if (!overlay || !titleEl || !imgEl || !descEl || !tagsEl || !likeEl || !openLink || !thumbsEl) return;

        titleEl.textContent = item && item.title ? String(item.title) : '';

        const urlsRaw = Array.isArray(item && item.imageUrls)
          ? item.imageUrls
          : (item && item.imageUrl ? [item.imageUrl] : []);
        const urls = urlsRaw
          .map((u) => normalizeHttpUrl(u))
          .filter(Boolean)
          .slice(0, 10);

        thumbsEl.innerHTML = '';

        const selectImage = (url, title) => {
          imgEl.src = url;
          imgEl.alt = title || 'Portfolio image';
          openLink.href = url;
          openLink.style.display = '';
        };

        if (urls.length) {
          selectImage(urls[0], item && item.title ? String(item.title) : 'Portfolio image');

          urls.forEach((url, idx) => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'portfolio-modal-thumb' + (idx === 0 ? ' active' : '');
            btn.setAttribute('aria-label', `View image ${idx + 1}`);

            const timg = document.createElement('img');
            timg.alt = '';
            timg.loading = 'lazy';
            timg.src = url;
            btn.appendChild(timg);

            btn.addEventListener('click', () => {
              thumbsEl.querySelectorAll('.portfolio-modal-thumb').forEach((el) => el.classList.remove('active'));
              btn.classList.add('active');
              selectImage(url, item && item.title ? String(item.title) : 'Portfolio image');
            });

            thumbsEl.appendChild(btn);
          });

          thumbsEl.style.display = urls.length > 1 ? '' : 'none';
        } else {
          imgEl.removeAttribute('src');
          imgEl.alt = '';
          openLink.href = '#';
          openLink.style.display = 'none';
          thumbsEl.style.display = 'none';
        }

        const desc = item && item.description ? String(item.description) : '';
        descEl.textContent = desc;
        descEl.style.display = desc.trim().length ? '' : 'none';

        tagsEl.innerHTML = '';
        const cat = item && item.category ? String(item.category) : '';
        if (cat.trim().length) {
          const span = document.createElement('span');
          span.textContent = cat;
          tagsEl.appendChild(span);
          tagsEl.style.display = '';
        } else {
          tagsEl.style.display = 'none';
        }

        const n = Number.isFinite(Number(item && item.likeCount)) ? Number(item.likeCount) : 0;
        likeEl.textContent = `${n.toLocaleString()} like${n === 1 ? '' : 's'}`;

        overlay.classList.add('open');
        overlay.setAttribute('aria-hidden', 'false');
        document.documentElement.style.overflow = 'hidden';
      }

      function closePortfolioModal() {
        const overlay = document.getElementById('portfolioModalOverlay');
        if (!overlay) return;
        overlay.classList.remove('open');
        overlay.setAttribute('aria-hidden', 'true');
        document.documentElement.style.overflow = '';
      }

      function renderPortfolio() {
        const grid = document.getElementById('portfolioGrid');
        if (!grid) return;
        clearElement(grid);
        for (const item of portfolioItems) grid.appendChild(createCard(item));
      }

      function wireFollowButton() {
        const btn = document.getElementById('followBtn');
        if (!btn) return;
        btn.addEventListener('click', async (e) => {
          e.preventDefault();
          if (!currentUser) {
            window.location.href = '../user/login.html';
            return;
          }

          const prevFollowing = isFollowing;
          btn.disabled = true;
          try {
            const res = await setFollowingCallable({ following: !isFollowing });
            const data = res && res.data ? res.data : {};
            isFollowing = data.following === true;
            setFollowButtonState();
            if (Number.isFinite(Number(data.followers))) setFollowersCount(Number(data.followers));

            // Notify admin only on a new follow (not on unfollow).
            if (!prevFollowing && isFollowing) {
              sendFollowNotificationCallable({}).catch((err) => {
                console.warn('Follow notification failed:', err);
              });
            }
          } catch (err) {
            console.error('Follow toggle failed:', err);
          } finally {
            btn.disabled = false;
          }
        });
      }

      function subscribePortfolio() {
        setStatus('Loading portfolio…');
        db.collection('portfolio').orderBy('createdAt', 'desc').onSnapshot((snap) => {
          portfolioItems = [];
          snap.forEach((doc) => portfolioItems.push({ id: doc.id, ...doc.data() }));
          if (portfolioItems.length === 0) {
            setStatus('No portfolio items yet.');
          } else {
            setStatus('');
          }
          renderPortfolio();
        }, (err) => {
          console.error('Portfolio subscription error:', err);
          setStatus('Could not load portfolio right now.');
        });
      }

      function subscribeProfile() {
        db.collection('profile').doc('dominic').onSnapshot((doc) => {
          const data = doc.exists ? doc.data() : {};
          setFollowersCount(data && data.followers);
        });
      }

      function subscribeCurrentUserDoc(uid) {
        return db.collection('users').doc(uid).onSnapshot((doc) => {
          const data = doc.exists ? doc.data() : {};
          userLikes = (data && typeof data.likes === 'object' && data.likes) ? data.likes : {};
          isFollowing = data && data.isFollowingDominic === true;
          setFollowButtonState();
          renderPortfolio();
        }, (err) => {
          console.error('User doc subscription error:', err);
        });
      }

      window.addEventListener('load', () => {
        wireFollowButton();
        subscribeProfile();
        subscribePortfolio();

        let unsubscribeUser = null;
        auth.onAuthStateChanged((user) => {
          currentUser = user || null;
          userLikes = {};
          isFollowing = false;
          setFollowButtonState();

          if (unsubscribeUser) {
            try { unsubscribeUser(); } catch { /* noop */ }
            unsubscribeUser = null;
          }

          if (currentUser) {
            unsubscribeUser = subscribeCurrentUserDoc(currentUser.uid);
          } else {
            renderPortfolio();
          }
        });
      });
    })();
  </script>
</body>
</html>
