<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; base-uri 'self'; object-src 'none'; form-action 'self'; img-src 'self' data: https: blob:; style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; font-src 'self' https://cdnjs.cloudflare.com data:; script-src 'self' 'unsafe-inline' https://www.gstatic.com https://www.googleapis.com https://apis.google.com https://cdnjs.cloudflare.com; script-src-attr 'none'; connect-src 'self' https://www.gstatic.com https://firestore.googleapis.com https://firebasestorage.googleapis.com https://storage.googleapis.com https://*.googleapis.com https://*.firebaseio.com https://www.googleapis.com; frame-src 'self' https://*.firebaseapp.com https://*.google.com https://accounts.google.com;">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - Dominic Martinez</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: linear-gradient(135deg, #020212 0%, #0f0a1a 100%);
      color: #f0f0f0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      min-height: 100vh;
    }

    /* ===== LOGIN SCREEN ===== */
    .login-container {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
    }

    .login-box {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      border: 2px solid rgba(124, 58, 237, 0.3);
      border-radius: 20px;
      padding: 60px 40px;
      width: 100%;
      max-width: 450px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      transition: all 0.3s ease;
    }

    .login-box.shake {
      animation: shake 0.5s ease-in-out;
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-10px); }
      75% { transform: translateX(10px); }
    }

    .login-header {
      text-align: center;
      margin-bottom: 40px;
    }

    .login-header h1 {
      font-size: 2.5rem;
      background: linear-gradient(135deg, #1B16A8, #7C3AED);
      background-clip: text;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 10px;
    }

    .login-header p {
      color: #999;
      font-size: 0.95rem;
    }

    .form-group {
      margin-bottom: 25px;
    }

    .form-group label {
      display: block;
      margin-bottom: 10px;
      color: #bbb;
      font-weight: 600;
      font-size: 0.95rem;
    }

    .form-group input {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid rgba(124, 58, 237, 0.3);
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.05);
      color: #f0f0f0;
      font-size: 1rem;
      transition: all 0.3s ease;
    }

    .form-group input:focus {
      outline: none;
      border-color: #7C3AED;
      background: rgba(124, 58, 237, 0.1);
      box-shadow: 0 0 20px rgba(124, 58, 237, 0.2);
    }

    .form-group input::placeholder {
      color: #666;
    }

    .login-btn {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #1B16A8, #7C3AED);
      color: #fff;
      border: none;
      border-radius: 10px;
      font-weight: 700;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 10px;
    }

    .login-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(123, 58, 237, 0.4);
    }

    .login-btn:active {
      transform: translateY(0);
    }

    .return-home-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      width: 100%;
      padding: 14px;
      background: transparent;
      color: #7C3AED;
      border: 2px solid #7C3AED;
      border-radius: 10px;
      font-weight: 700;
      font-size: 1rem;
      cursor: pointer;
      text-decoration: none;
      transition: all 0.3s ease;
      margin-top: 12px;
    }

    .return-home-btn:hover {
      background: rgba(124, 58, 237, 0.1);
      transform: translateY(-1px);
      box-shadow: 0 10px 30px rgba(123, 58, 237, 0.25);
    }

    .error-message {
      background: rgba(231, 76, 60, 0.2);
      border: 2px solid #e74c3c;
      border-radius: 10px;
      padding: 15px;
      color: #ef5350;
      margin-bottom: 20px;
      display: none;
      font-weight: 600;
      animation: slideIn 0.3s ease;
    }

    .error-message.show {
      display: block;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .hint {
      text-align: center;
      color: #666;
      font-size: 0.85rem;
      margin-top: 20px;
    }

    .hint a {
      color: #7C3AED;
      text-decoration: none;
      cursor: pointer;
    }

    .hint a:hover {
      text-decoration: underline;
    }

    /* ===== DASHBOARD SCREEN ===== */
    .dashboard-container {
      display: none;
    }

    header {
      background: linear-gradient(135deg, #1B16A8 0%, #020212 100%);
      padding: 20px 0;
      border-bottom: 1px solid rgba(124, 58, 237, 0.2);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo {
      font-size: 1.8rem;
      font-weight: 800;
      background: linear-gradient(135deg, #1B16A8, #7C3AED);
      background-clip: text;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .header-actions {
      display: flex;
      gap: 15px;
      align-items: center;
    }

    .user-info {
      color: #ccc;
      font-size: 0.9rem;
    }

    .logout-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      background: transparent;
      color: #7C3AED;
      border: 2px solid #7C3AED;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      text-decoration: none;
      white-space: nowrap;
      flex: 0 0 auto;
    }

    .logout-btn:hover {
      background: rgba(124, 58, 237, 0.1);
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 40px 20px;
    }

    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 24px;
      margin-top: 10px;
    }

    .section {
      background: radial-gradient(circle at top left, rgba(124, 58, 237, 0.2), transparent 55%),
                  linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      border: 1px solid rgba(124, 58, 237, 0.25);
      border-radius: 18px;
      padding: 26px 24px;
      box-shadow: 0 18px 45px rgba(0, 0, 0, 0.45);
      text-align: left;
    }

    .section h2 {
      font-size: 1.5rem;
      margin-bottom: 10px;
      color: #7C3AED;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .section h2 i {
      font-size: 1.4rem;
    }

    .section p {
      font-size: 0.95rem;
      color: #ccc;
      margin-bottom: 16px;
    }

    .tile-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 18px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.9rem;
      background: linear-gradient(135deg, #1B16A8, #7C3AED);
      color: #fff;
      text-decoration: none;
    }

    .tile-btn:hover {
      box-shadow: 0 10px 30px rgba(123, 58, 237, 0.35);
      transform: translateY(-1px);
    }

    .message {
      padding: 16px;
      border-radius: 10px;
      margin-bottom: 20px;
      display: none;
      font-weight: 600;
      animation: slideIn 0.3s ease;
    }

    .message.show {
      display: block;
    }

    .message.success {
      background: rgba(76, 175, 80, 0.2);
      border: 1px solid #4caf50;
      color: #81c784;
    }

    .message.error {
      background: rgba(244, 67, 54, 0.2);
      border: 1px solid #f44336;
      color: #ef5350;
    }

    .loading {
      display: inline-block;
      width: 18px;
      height: 18px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #666;
    }

    .empty-state i {
      font-size: 3rem;
      margin-bottom: 15px;
      color: #7C3AED;
    }

    .headshot-admin {
      display: grid;
      grid-template-columns: 120px 1fr;
      gap: 16px;
      align-items: start;
      margin-top: 14px;
    }

    .headshot-admin img {
      width: 120px;
      height: 120px;
      border-radius: 18px;
      object-fit: cover;
      border: 2px solid rgba(124, 58, 237, 0.35);
      background: rgba(0,0,0,0.2);
    }

    .headshot-actions {
      display: flex;
      flex-direction: column;
      align-items: stretch;
      gap: 10px;
    }

    .visually-hidden {
      position: absolute !important;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    #adminHeadshotUploadBtn {
      white-space: nowrap;
      justify-content: center;
      width: auto;
      align-self: flex-start;
      padding: 8px 12px;
      font-size: 0.82rem;
    }

    #adminHeadshotChooseBtn {
      width: 100%;
      justify-content: center;
      cursor: pointer;
      padding: 9px 14px;
      font-size: 0.85rem;
    }

    .headshot-filename {
      margin-top: 8px;
      color: #aaa;
      font-size: 0.85rem;
      word-break: break-word;
    }

    .headshot-status {
      margin-top: 10px;
      color: #aaa;
      font-size: 0.9rem;
      min-height: 1.2em;
    }

    /* Keep headshot controls stacked even on wide viewports for clarity */

    @media (max-width: 968px) {
      .dashboard-grid {
        grid-template-columns: 1fr;
      }

      .section {
        padding: 25px;
      }

      .section h2 {
        font-size: 1.4rem;
      }

      .login-box {
        padding: 40px 25px;
      }
    }

    @media (max-width: 480px) {
      .container {
        padding: 20px 15px;
      }

      .section {
        padding: 20px;
      }

      .upload-area {
        padding: 35px 20px;
      }

      .upload-area i {
        font-size: 2.5rem;
      }

      .header-content {
        flex-direction: column;
        gap: 15px;
      }

      .header-actions {
        width: 100%;
        justify-content: flex-start;
        flex-wrap: wrap;
        gap: 10px;
      }

      .header-actions .user-info {
        width: 100%;
      }

      .login-box {
        padding: 30px 20px;
      }

      .login-header h1 {
        font-size: 1.8rem;
      }

      .headshot-admin {
        grid-template-columns: 1fr;
      }

      .headshot-admin img {
        width: 140px;
        height: 140px;
      }
    }
  </style>
</head>
<body>
  <!-- DASHBOARD SCREEN -->
  <div id="dashboardContainer" class="dashboard-container">
    <header>
      <div class="header-content">
        <div class="logo">ðŸ“¸ Admin Dashboard</div>
        <div class="header-actions">
          <div class="user-info">Admin User</div>
          <a class="logout-btn" href="../index.html">
            <i class="fas fa-home"></i> Home
          </a>
          <button class="logout-btn" id="logoutBtn" type="button">Logout</button>
        </div>
      </div>
    </header>

    <div class="container">
      <div class="dashboard-intro">
        <h2 style="margin-bottom:10px; font-size:1.9rem;">Welcome, Admin</h2>
        <p style="color:#bbb; max-width:640px; margin-bottom:24px;">Use this dashboard to manage your website content and portfolio without touching the code. Choose a tool below to get started.</p>
      </div>

      <div class="dashboard-grid">
        <div class="section">
          <h2><i class="fas fa-pen-to-square"></i> Edit Web Pages</h2>
          <p>Update hero text, About content, Experience headings, and Skills call-to-actions across your site.</p>
          <button class="tile-btn" type="button" data-href="content.html"><i class="fas fa-arrow-right"></i> Go to Site Content</button>
        </div>

        <div class="section">
          <h2><i class="fas fa-images"></i> Manage Portfolio Posts</h2>
          <p>Upload new work, edit existing projects, and keep your portfolio grid fresh and up to date.</p>
          <button class="tile-btn" type="button" data-href="portfolio.html"><i class="fas fa-arrow-right"></i> Go to Portfolio Manager</button>
        </div>

        <div class="section">
          <h2><i class="fas fa-user-edit"></i> Admin Profile</h2>
          <p>Adjust the display name and contact details associated with your admin account for future personalization.</p>
          <button class="tile-btn" type="button" data-href="profile.html"><i class="fas fa-arrow-right"></i> Go to Profile</button>
        </div>

        <div class="section">
          <h2><i class="fas fa-id-badge"></i> Site Headshot</h2>
          <p>Update the headshot image used on your homepage and About page (and wherever the site uses the shared headshot).</p>

          <div class="headshot-admin">
            <img id="adminHeadshotPreview" src="../image/Headshot.jpg" alt="Current headshot preview" loading="lazy" decoding="async">
            <div>
              <div class="headshot-actions">
                <label id="adminHeadshotChooseBtn" class="tile-btn" for="adminHeadshotFile">
                  <i class="fas fa-file-image"></i> Choose Image
                </label>
                <input id="adminHeadshotFile" class="visually-hidden" type="file" accept="image/*" aria-label="Choose a new headshot image">
                <button id="adminHeadshotUploadBtn" class="tile-btn" type="button">
                  <i class="fas fa-upload"></i> Upload Headshot
                </button>
              </div>
              <div id="adminHeadshotFileName" class="headshot-filename">No file chosen.</div>
              <div id="adminHeadshotStatus" class="headshot-status"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase Scripts (Compat Version for Script Tag Loading) -->
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-storage-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/heic2any/0.0.4/heic2any.min.js"></script>
  <script src="/assets/js/firebase-config.js"></script>
  <script src="/assets/js/firebase-init-compat.js"></script>
  <script src="/assets/js/admin-config.js"></script>

  <script>
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();
    console.log('ðŸ” Admin dashboard loading...');
    let dashboardHandlersAttached = false;

    const LOGIN_URL = '/user/login.html';
    const HOME_URL = '/';

    // Require the standard site login; no separate admin login UI.
    window.addEventListener('load', function() {
      auth.onAuthStateChanged(async user => {
        if (!user) {
          console.log('âœ— Not authenticated, redirecting to login');
          window.location.replace(LOGIN_URL);
          return;
        }

        if (!window.__ADMIN_UID) {
          console.warn('âš ï¸ Admin UID not configured. Blocking admin access.');
          try { await auth.signOut(); } catch {}
          window.location.replace(HOME_URL);
          return;
        }

        if (user.uid !== window.__ADMIN_UID) {
          console.warn('â›” Not authorized for admin dashboard:', user.email);
          try { await auth.signOut(); } catch {}
          window.location.replace(HOME_URL);
          return;
        }

        console.log('âœ“ Admin authenticated as', user.email);
        showDashboard();
      });
    });

    function showDashboard() {
      const dashboardContainer = document.getElementById('dashboardContainer');
      if (dashboardContainer) dashboardContainer.style.display = 'block';
      attachDashboardHandlers();
      loadCurrentHeadshot();
      console.log('Dashboard now visible');
    }

    function attachDashboardHandlers() {
      if (dashboardHandlersAttached) return;
      dashboardHandlersAttached = true;

      const logoutBtn = document.getElementById('logoutBtn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', logout);
      }

      document.querySelectorAll('button.tile-btn[data-href]').forEach((btn) => {
        btn.addEventListener('click', () => {
          const href = btn.getAttribute('data-href');
          if (href) window.location.href = href;
        });
      });

      const fileInput = document.getElementById('adminHeadshotFile');
      const uploadBtn = document.getElementById('adminHeadshotUploadBtn');
      const preview = document.getElementById('adminHeadshotPreview');
      const status = document.getElementById('adminHeadshotStatus');
      const fileNameEl = document.getElementById('adminHeadshotFileName');
      let previewObjectUrl = null;

      if (fileInput) {
        fileInput.addEventListener('change', () => {
          if (!preview) return;
          try {
            if (previewObjectUrl) {
              URL.revokeObjectURL(previewObjectUrl);
              previewObjectUrl = null;
            }
          } catch {}

          const f = fileInput.files && fileInput.files[0];
          if (!f) {
            if (fileNameEl) fileNameEl.textContent = 'No file chosen.';
            return;
          }
          try {
            previewObjectUrl = URL.createObjectURL(f);
            preview.src = previewObjectUrl;
            if (fileNameEl) fileNameEl.textContent = f.name || 'Selected image';
            if (status) status.textContent = 'Ready to upload.';
          } catch (e) {
            console.warn('Preview failed:', e);
          }
        });
      }

      if (uploadBtn) {
        uploadBtn.addEventListener('click', async () => {
          const f = fileInput && fileInput.files && fileInput.files[0];
          if (!f) {
            if (status) status.textContent = 'Choose an image first.';
            return;
          }

          uploadBtn.disabled = true;
          if (status) status.textContent = 'Optimizingâ€¦';

          try {
            const stamp = Date.now();
            const optimized = await optimizeHeadshotFile(f);
            const path = `siteAssets/headshot_${stamp}.jpg`;
            const ref = storage.ref().child(path);

            if (status) status.textContent = 'Uploadingâ€¦';

            await ref.put(optimized.blob, {
              contentType: 'image/jpeg',
              cacheControl: 'public,max-age=86400'
            });

            const downloadUrl = await ref.getDownloadURL();
            const versionedUrl = downloadUrl + (downloadUrl.includes('?') ? '&' : '?') + `v=${stamp}`;

            await db.collection('siteContent').doc('global').set({
              headshotUrl: versionedUrl,
              headshotUpdatedAt: firebase.firestore.FieldValue.serverTimestamp(),
              headshotPath: path
            }, { merge: true });

            if (status) status.textContent = 'Headshot updated. It may take a moment to show everywhere.';

            try {
              if (fileInput) fileInput.value = '';
              if (fileNameEl) fileNameEl.textContent = 'No file chosen.';
            } catch {}
          } catch (e) {
            console.error('Headshot upload failed:', e);
            const code = (e && typeof e.code === 'string') ? e.code : '';
            const msg = (e && typeof e.message === 'string') ? e.message : '';
            const detail = [code, msg].filter(Boolean).join(': ');
            if (status) {
              if (code === 'storage/unauthorized') {
                const uid = (window.__ADMIN_UID && typeof window.__ADMIN_UID === 'string') ? window.__ADMIN_UID : '(admin UID not set)';
                status.textContent = `Upload blocked by Firebase Storage Rules (storage/unauthorized). In Firebase Console â†’ Storage â†’ Rules, allow write for UID ${uid} to /siteAssets/**. ${msg ? 'Details: ' + msg : ''}`;
              } else {
                status.textContent = detail ? `Upload failed (${detail}).` : 'Upload failed. Check console/CSP and try again.';
              }
            }
          } finally {
            uploadBtn.disabled = false;
          }
        });
      }
    }

    async function optimizeHeadshotFile(file) {
      // Returns: { blob: Blob }
      let srcBlob = file;

      // HEIC conversion best-effort (common on iPhone camera roll).
      const name = (file && file.name) ? file.name.toLowerCase() : '';
      const type = (file && file.type) ? file.type.toLowerCase() : '';
      const looksHeic = type.includes('heic') || name.endsWith('.heic');
      if (looksHeic && window.heic2any) {
        try {
          const converted = await heic2any({ blob: file, toType: 'image/jpeg', quality: 0.92 });
          // heic2any may return a Blob or an Array of Blobs
          srcBlob = Array.isArray(converted) ? converted[0] : converted;
        } catch (e) {
          console.warn('HEIC convert failed:', e);
          throw new Error('This image looks like HEIC and could not be converted. Please export/save as JPG/PNG and try again.');
        }
      } else if (looksHeic && !window.heic2any) {
        throw new Error('This image looks like HEIC but the converter did not load. Please try again on a stronger connection or upload a JPG/PNG.');
      }

      let img;
      try {
        img = await blobToImage(srcBlob);
      } catch (e) {
        console.warn('Image decode failed:', e);
        throw new Error('Could not read this image file. Try a different photo or upload a JPG/PNG.');
      }

      // Resize for web usage. Keep enough for retina displays.
      const maxDim = 900;
      const w = img.naturalWidth || img.width;
      const h = img.naturalHeight || img.height;
      const scale = Math.min(1, maxDim / Math.max(w, h));
      const outW = Math.max(1, Math.round(w * scale));
      const outH = Math.max(1, Math.round(h * scale));

      const canvas = document.createElement('canvas');
      canvas.width = outW;
      canvas.height = outH;

      const ctx = canvas.getContext('2d');
      if (!ctx) {
        return { blob: srcBlob };
      }

      // If source has transparency (PNG), fill with white for JPEG.
      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0, 0, outW, outH);
      ctx.imageSmoothingEnabled = true;
      ctx.imageSmoothingQuality = 'high';
      ctx.drawImage(img, 0, 0, outW, outH);

      const blob = await canvasToBlob(canvas, 'image/jpeg', 0.84);
      return { blob: blob || srcBlob };
    }

    function blobToImage(blob) {
      return new Promise((resolve, reject) => {
        try {
          const url = URL.createObjectURL(blob);
          const img = new Image();
          img.decoding = 'async';
          img.onload = () => {
            try { URL.revokeObjectURL(url); } catch {}
            resolve(img);
          };
          img.onerror = (e) => {
            try { URL.revokeObjectURL(url); } catch {}
            reject(e);
          };
          img.src = url;
        } catch (e) {
          reject(e);
        }
      });
    }

    function canvasToBlob(canvas, mime, quality) {
      return new Promise((resolve) => {
        try {
          if (!canvas.toBlob) {
            resolve(null);
            return;
          }
          canvas.toBlob((b) => resolve(b), mime, quality);
        } catch {
          resolve(null);
        }
      });
    }

    async function loadCurrentHeadshot() {
      const preview = document.getElementById('adminHeadshotPreview');
      const status = document.getElementById('adminHeadshotStatus');
      if (!preview) return;
      try {
        const snap = await db.collection('siteContent').doc('global').get();
        if (snap && snap.exists) {
          const data = snap.data() || {};
          if (typeof data.headshotUrl === 'string' && data.headshotUrl.trim()) {
            preview.src = data.headshotUrl.trim();
            if (status) status.textContent = 'Current headshot loaded.';
            return;
          }
        }
        if (status) status.textContent = '';
      } catch (e) {
        console.warn('Headshot load failed:', e);
        if (status) status.textContent = '';
      }
    }

    function logout() {
      auth.signOut().then(() => {
        window.location.href = HOME_URL;
      });
    }

    function showSuccess() {}
    function showError() {}
  </script>
</body>
</html>
